{% extends "base.html" %}
{% block content %}
{% set H = hours|default(1)|int %}

<style>
  /* ——— Palette ——— */
  :root{
    --bg:#edf2f7;                 /* light page */
    --text:#25344a;               /* page text */
    --muted:#5e708a;              /* page secondary */
    --panel:#0f2238;              /* dark card for charts */
    --panel-text:#e6eef8;         /* text on dark card */
    --panel-stroke:rgba(255,255,255,.14);
    --grid:rgba(255,255,255,.08); /* gridlines on dark card */
    --aqua:#00e1d1;               /* Bermuda-water accent */
    --page-max:1100px;
    --gap:12px;
    --radius:12px;
  }

  /* ---- Top cluster refactor (replaces your old h1/periodMenu/btn-group rules) ---- */

/* Heading */
h1{
  margin: 2px 0 2px;
  font-size: clamp(20px, 2.6vw, 32px);
  font-weight: 500;
  line-height: 1.1;
  letter-spacing: -0.01em;
}
h1::after{
  content:"";
  display:block;
  width:68px; height:2px;
  margin:4px auto 0;
  background: var(--muted); /* #5e708a */
  opacity:.7; border-radius:999px;
}

/* “Recent winds at Crescent” line */
.periodMenu p{
  margin: 0 0 2px;
  line-height: 1.12;
}
.periodMenu p a[href="/crescent"]{
  color: var(--muted);
  font-weight: 600;
  text-decoration: none;
}
.periodMenu p a[href="/crescent"]:hover{
  text-decoration: underline;
}

/* Segmented control */
.periodMenu .btn-group{ margin: 0 0 4px; }

/* slightly shorter pills */
.periodMenu .btn{
  padding: 2px 10px;
  font-size: .95rem;
  line-height: 1.12;
}

/* subtle transitions + clear keyboard focus */
.periodMenu .btn{
  transition: background-color .15s ease, border-color .15s ease, box-shadow .15s ease;
}
.periodMenu .btn:focus{
  outline: 0;
  box-shadow: 0 0 0 2px rgba(94,112,138,.22) inset, 0 0 0 2px rgba(94,112,138,.18);
}
/* hint of depth on active */
.periodMenu .btn-primary.active{
  box-shadow: inset 0 1px 0 rgba(255,255,255,.15);
}

/* Inactive pills: extra-light */
.periodMenu .btn-primary{
  --bs-btn-color: var(--text);
  --bs-btn-bg: color-mix(in srgb, var(--muted) 8%, white);
  --bs-btn-border-color: color-mix(in srgb, var(--muted) 28%, white);
  --bs-btn-hover-bg: color-mix(in srgb, var(--muted) 14%, white);
  --bs-btn-hover-border-color: color-mix(in srgb, var(--muted) 40%, white);

  /* what Bootstrap uses when a button is .active (pressed/selected) */
  --bs-btn-active-bg: color-mix(in srgb, var(--muted) 24%, white);
  --bs-btn-active-border-color: color-mix(in srgb, var(--muted) 50%, white);
}

/* Selected pill: solid + white text */
.periodMenu .btn-primary.active,
.periodMenu .btn-primary[aria-current="page"]{
  --bs-btn-color: #fff;
  --bs-btn-bg: var(--muted);
  --bs-btn-border-color: var(--muted);
  --bs-btn-hover-bg: #506076;
  --bs-btn-hover-border-color: #506076;

  /* CRITICAL for Bootstrap's .active rule */
  --bs-btn-active-bg: var(--muted);
  --bs-btn-active-border-color: var(--muted);

  font-weight: 700;
}


/* segment radii */
.periodMenu .btn-group > .btn{ border-radius: 0; }
.periodMenu .btn-group > .btn:first-child{ border-radius: 999px 0 0 999px; }
.periodMenu .btn-group > .btn:last-child{  border-radius: 0 999px 999px 0; }


  /* ——— Base + compact spacing ——— */
  *{margin:0;padding:0;font-family:Arial,Helvetica,sans-serif}
  body{background:var(--bg)!important;color:var(--text);line-height:1.35}
  h1{margin:8px 0 2px;font-weight:800;letter-spacing:.02em;font-size:clamp(26px,4vw,44px)}
  h2,h3{margin:8px 0 4px}


  /* Only the 'Crescent' inline link in the header */
  .periodMenu p a[href="/crescent"]{
    color:#5e708a !important;
    font-weight:600;
    text-decoration:none;
  }
  .periodMenu p a[href="/crescent"]:hover{
    text-decoration:underline;
  }

  .periodMenu{ margin:2px 0 2px; color:var(--text) }
  .btn-group{ margin:2px auto 2px}
    /* Segmented 3-piece pill in the header */
    .periodMenu .btn-group .btn{ border-radius:0!important; }
  .periodMenu .btn-group .btn:first-child{
    border-top-left-radius:999px!important; border-bottom-left-radius:999px!important;
  }
  .periodMenu .btn-group .btn:last-child{
    border-top-right-radius:999px!important; border-bottom-right-radius:999px!important;
  }
  /*.periodMenu .btn-group .btn.btn-primary{
    background-color:#5e708a!important; border-color:#5e708a!important;
  }
  .periodMenu .btn-group .btn.btn-primary:hover,
  .periodMenu .btn-group .btn.btn-primary:focus{
    background-color:#506076!important; border-color:#506076!important;
  }*/
  .windTable table{ margin:0px auto 2px; color:var(--text); border-collapse:separate; border-spacing:0 .15rem }
  .windTable th{ padding:.25rem .45rem; text-align:center; font-weight:normal; color:var(--muted) }
  .windTable td{ padding:.3rem .5rem; text-align:center; font-size:clamp(22px,3.3vw,40px); font-weight:700 }

  /* ——— Centered page wrapper + rhythm ——— */
  .page{ max-width:var(--page-max); margin:0 auto; padding:8px 12px; }
  .stack{ display:grid; grid-auto-rows:min-content; gap:var(--gap); }

  /* ——— One card style for ALL charts ——— */
  .chartBox{
    width:100%;
    padding:4px 6px;
    border-radius:var(--radius);
    overflow:hidden;                  /* clip canvas corners */
    background:var(--panel);
    color:var(--panel-text);
    border:1px solid var(--panel-stroke);
    height:360px;                    /* 1-hour default */
  }

  .chartBox.tall{ height:360px; }    /* 3h / 8h */

  .chartBox canvas{
  display: block;
  background: transparent;
  width: 100% !important;
  height: 100% !important;
  }

  @media (max-width:640px){
    .chartBox{ height:220px; }
    .chartBox.tall{ height: 220px; }
  }
    
  .chartBox canvas{ background:transparent; }

  a{color:var(--aqua);text-decoration:none}
  a:hover{filter:brightness(1.1)}

  /* lift the cards a touch + unify corners */
.chartBox{
  box-shadow: 0 6px 20px rgba(0,0,0,.18);
  border-radius: 14px;
}

/* summary row: tidy and responsive */
.windTable table{
  margin: 8px auto 2px;
}
.windTable thead th{ font-size: clamp(16px,2.3vw,22px); }
.windTable td{
  padding:.35rem .6rem;
  font-size: clamp(20px,3vw,36px);
}

/* time-range buttons to match theme */
.btn-group .btn,
.btn-group .btn.btn-primary{
  /* was background:#162a45; border:1px solid var(--panel-stroke); color:var(--panel-text) */
  background: rgba(15,34,56,.08) !important;      /* subtle, light */
  border: 1px solid rgba(15,34,56,.18) !important;
  color: var(--text) !important;
  padding: 5px 10px;                               /* slimmer */
  border-radius: 10px;
  box-shadow: none;
}
.btn-group .btn:hover{ background: rgba(15,34,56,.12) !important; }

/* active state: gentle aqua emphasis */
.btn-group .active{
  background: rgba(0,225,209,.14) !important;
  border-color: var(--aqua) !important;
  box-shadow: 0 0 0 2px rgba(0,225,209,.16) inset;
}

/* page spacing */
.page{ padding-top: 6px; }
.stack{ gap: 12px; }

/* ---- PERIOD MENU PILLS (Bootstrap 4 compatible) ---- */

/* shape */
.periodMenu .btn-group .btn{ 
  border-radius:0 !important; 
  padding:3px 10px; 
  line-height:1.1;
  box-shadow:none !important;
}
.periodMenu .btn-group .btn:first-child{
  border-top-left-radius:999px !important; 
  border-bottom-left-radius:999px !important;
}
.periodMenu .btn-group .btn:last-child{
  border-top-right-radius:999px !important; 
  border-bottom-right-radius:999px !important;
}

/* INACTIVE (very light) */
.periodMenu .btn-group .btn.btn-primary{
  background-color: rgba(94,112,138,0.08) !important;   /* lighter fill */
  border-color:     rgba(94,112,138,0.28) !important;
  color: var(--text) !important;
}
.periodMenu .btn-group .btn.btn-primary:hover{
  background-color: rgba(94,112,138,0.14) !important;
  border-color:     rgba(94,112,138,0.40) !important;
}

/* ACTIVE (selected) */
.periodMenu .btn-group .btn.btn-primary.active,
.periodMenu .btn-group .btn.btn-primary[aria-current="page"]{
  background-color: #5e708a !important;
  border-color:     #5e708a !important;
  color:#fff !important;
  font-weight:700;
}

/* targets that specific line under the tide chart */
.page .text-center p{
  font-size: clamp(20px, 1.6vw, 18px);
  font-weight: 700;
  letter-spacing: .01em;
  opacity: .95;
  margin: 4px 0 0;
}

/* More space *between* the four columns (Avg / Max / Min / Dir) */
.windTable table{
  /* border-spacing: H  V */
  border-spacing: .75rem .04rem;   /* was 0 .04rem */
}

/* Keep the label↔number gap tight while adding side breathing room */
.windTable thead th{
  padding: .12rem .35rem .06rem;   /* top | L/R | bottom (slightly less L/R) */
}
.windTable tbody td{
  padding: .06rem .35rem 0;        /* top | L/R | bottom */
}

/* Slightly smaller gaps on phones */
@media (max-width: 640px){
  .windTable table{ border-spacing: .5rem .03rem; }
}

/* a bit shorter than the wind card */
.chartBox.tide{ height:420px; }
@media (max-width:640px){
  .chartBox.tide{ height:220px; }
}


</style>

<!-- Header / menu -->
<div class="periodMenu">
  <div class="container">
    <center>
      <p>Recent winds at <a href="/crescent">Crescent</a></p>
      <div class="btn-group">
        <a class="btn btn-primary {{ 'active' if H==1 else '' }}" href="{{ url_for('winds', hours=1) }}">1 hour</a>
        <a class="btn btn-primary {{ 'active' if H==3 else '' }}" href="{{ url_for('winds', hours=3) }}">3 hours</a>
        <a class="btn btn-primary {{ 'active' if H==8 else '' }}" href="{{ url_for('winds', hours=8) }}">8 hours</a>
      </div>
      
    </center>
  </div>
</div>

<!-- Summary numbers -->
<div class="windTable">
  <div class="container">
    <table>
      <thead>
        <tr><th>Avg</th><th>Max</th><th>Min</th><th>Dir</th></tr>
      </thead>
      <tbody>
        <tr>
          <td>{{ past_hour_avg_wind_spd|round(1) }}</td>
          <td>{{ past_hour_avg_wind_max|round(1) }}</td>
          <td>{{ past_hour_avg_wind_min|round(1) }}</td>
          <td>{{ avg_wind_dir }}</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- Charts -->
<!-- Charts (centered, consistent width) -->
<div class="page stack">
  <div class="chartBox {{ 'tall' if H >= 3 else '' }}">
    <canvas id="myChart"></canvas>
  </div>



<!-- Libraries -->
<script src="https://code.jquery.com/jquery-3.6.0.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.4.4/d3.min.js"
  integrity="sha512-hnFpvCiJ8Fr1lYLqcw6wLgFUOEZ89kWCkO+cEekwcWPIPKyknKV1eZmSSG3UxXfsSuf+z/SgmiYB1zFOg3l2UQ=="
  crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>



<!-- Shared Chart.js options + wind chart (single block) -->

<script>
  const DPR = Math.min(2, window.devicePixelRatio || 1);
</script>

<script>
  // palette
  const css        = getComputedStyle(document.documentElement);
  const AQUA       = css.getPropertyValue('--aqua').trim();
  const GRID       = css.getPropertyValue('--grid').trim();
  const PANEL_TEXT = css.getPropertyValue('--panel-text').trim();

  // range flags from Jinja
  const H       = {{ H }};                                   // already set at top
  const isLong  = {{ (H >= 3) | tojson }};
  const TENSION = {{ (0.25 if H >= 8 else 0.35) | tojson }};

  // data (use tojson, not |safe)
  const labels = {{ labels | tojson }};
  const values = {{ values | tojson }};

  const commonOptions = {
    responsive: true,
    maintainAspectRatio: false,
    devicePixelRatio: DPR,   
    plugins: {
      legend: { display: !isLong, fullSize:false,
        labels:{ color: PANEL_TEXT, boxWidth:12, boxHeight:12, padding:8 } },
      tooltip: {
        backgroundColor: '#0f2238',
        titleColor: PANEL_TEXT, bodyColor: PANEL_TEXT,
        borderColor: 'rgba(255,255,255,.15)', borderWidth:1, padding:8
      }
      // decimation left off for now to keep things simple
    },
    elements: { point: { radius: isLong ? 2 : 3, hoverRadius: isLong ? 3 : 5 } },
    scales: {
      x: { grid:{ color: GRID }, ticks:{ color: AQUA, autoSkip:true, maxTicksLimit: isLong ? 12 : 8 } },
      y: {
        grid:{ color: GRID }, ticks:{ color: AQUA, maxTicksLimit: isLong ? 7 : 6 },
        beginAtZero:true,
        title:{ display:true, text:'Wind Speed kts', color:PANEL_TEXT }
      }
    }
  };

  const windData = {
    labels,
    datasets: [{
      label: "wind speeds",
      data: values,
      borderColor: AQUA,
      backgroundColor: 'rgba(0,225,209,.15)',
      pointBackgroundColor: AQUA,
      borderWidth: 2,
      tension: TENSION
    }]
  };

  new Chart(document.getElementById('myChart'), {
    type: 'line',
    data: windData,
    options: commonOptions
  });
</script>


  <!-- Tide chart (uniform look + dark-card shading) -->
  {% if tide_ok %}
  <div class="chartBox tide">
    <canvas id="myChartTide"></canvas>
  </div>
  <div class="text-center" style="margin-top:8px;">
    <p class="next-tide">Next tide is {{ next_peak_state }} at {{ next_peak_time }}</p>
  </div>

  <script>
  (function () {
    const el = document.getElementById('myChartTide');
    if (!el) return;                         // safety if DOM changes
    const ctx = el.getContext('2d');
    const DPR = Math.min(2, window.devicePixelRatio || 1);

    // helpers
    function getCurrentX(hour, ca){ const r = hour/24; return ca.left + r*(ca.right-ca.left); }
    function timeToDecimal(timeString){
      const [time, period] = timeString.split(" ");
      let [h,m,s] = time.split(":").map(Number); m = m||0; s = s||0;
      if (period === 'PM' && h !== 12) h += 12;
      if (period === 'AM' && h === 12) h = 0;
      return h + m/60 + s/3600;
    }
    function drawTimeLinesAndShading(animation, sunriseTime, sunsetTime) {
      const chart = animation.chart, ctx = chart.ctx, ca = chart.chartArea;
      const sunriseHour = timeToDecimal(sunriseTime);
      const sunsetHour  = timeToDecimal(sunsetTime);
      const now         = new Date();
      const currentHour = now.getHours() + now.getMinutes()/60;
      const currentX = getCurrentX(currentHour,  ca);
      const sunriseX = getCurrentX(sunriseHour, ca);
      const sunsetX  = getCurrentX(sunsetHour,  ca);

      ctx.save();
      ctx.fillStyle = 'rgba(255,255,255,0.06)';
      ctx.fillRect(ca.left, ca.top, sunriseX - ca.left, ca.bottom - ca.top);
      ctx.fillRect(sunsetX,  ca.top, ca.right  - sunsetX, ca.bottom - ca.top);
      [[currentX, AQUA], [sunriseX, 'rgba(255,255,255,0.5)'], [sunsetX, 'rgba(255,255,255,0.5)']]
        .forEach(([x, color]) => { ctx.beginPath(); ctx.moveTo(x, ca.top); ctx.lineTo(x, ca.bottom); ctx.strokeStyle = color; ctx.lineWidth = 2; ctx.stroke(); });
      ctx.restore();
    }

    // sunrise/sunset → tide series → chart
    jQuery.ajax({
      url: "https://api.sunrise-sunset.org/json?lat=32.2949&lng=-64.7830&date=today",
      type: 'GET', dataType: 'json',
      success: function (data) {
        function toBDA(utcTime){
          const tz = 'Atlantic/Bermuda';
          const d = new Date();
          const [t, period] = utcTime.split(' ');
          let [h,m,s] = t.split(':').map(Number);
          if (period === "PM" && h !== 12) h += 12;
          if (period === "AM" && h === 12) h = 0;
          const utcDate = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate(), h, m, s||0));
          return new Intl.DateTimeFormat('en-US', { timeZone: tz, hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:true }).format(utcDate);
        }
        const sunrise = toBDA(data.results.sunrise);
        const sunset  = toBDA(data.results.sunset);

        $.getJSON('/data', function (tideData) {
          const vals   = (tideData.values || []).map(Number);
          const fullHr = (tideData.times || []).map(t => `${parseInt(t.split(" ")[1].split(":")[0],10)}:00`);
          const labels = fullHr.map(l => ["6:00","12:00","18:00"].includes(l) ? l : "");

          // scaled y-range
          const vMin = Math.min(...vals), vMax = Math.max(...vals);
          const pad  = Math.max((vMax - vMin) * 0.15, 0.2);

          const tideChart = new Chart(ctx, {
            type: 'line',
            data: {
              labels,
              datasets: [{
                label: "Bermuda's tides today",
                data: vals,
                borderColor: AQUA,
                backgroundColor: 'rgba(0,225,209,.12)',
                tension: 0.25,
                borderWidth: 3,
                pointRadius: 0
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              devicePixelRatio: DPR,                // crisp
              scales: {
                x: { grid:{ color: GRID }, ticks:{ color: AQUA, autoSkip:true, maxRotation:0 } },
                y: { beginAtZero:false, min:vMin - pad, max:vMax + pad, grid:{ color: GRID }, ticks:{ color: AQUA } }
              },
              plugins: {
                title: { display:true, text:'Bermuda Tides Today', color:PANEL_TEXT,
                         font:{ size:14, weight:600, family:'system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial' },
                         padding:{ top:10, bottom:10 } },
                legend: { display:false }
              },
              animation: { onComplete: (a) => drawTimeLinesAndShading(a, sunrise, sunset) },
              elements: { point: { radius: 0 } }
            }
          });

          // make sure it stretches to the final width
          requestAnimationFrame(() => tideChart.resize());
        });
      }
    });
  })();
  </script>
{% endif %}


<!-- Bootstrap JS (optional; your base.html may already include these) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
  integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
  integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>

{% endblock %}
