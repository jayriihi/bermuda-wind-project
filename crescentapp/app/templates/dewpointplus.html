{% extends "base.html" %}

{% block title %}
Bermuda Dew Point 3-Day Forecast
{% endblock %}

{% block content %}
<div class="container py-4 px-3">
  <!-- Main Heading -->
  <h1 style="font-size: 1.75rem; text-align: center; margin-bottom: 2rem;">
    Bermuda Dew Point, Temperature, and Humidity 3-Day Forecast
  </h1>

  <!-- Chart Section -->
  <div class="row mb-5">
    <div class="col-12">
      <div class="chart-wrap">
        <div class="chartBox" style="height:400px; width:100%;">
          <canvas id="dewPointChart"></canvas>
        </div>
        <div class="legend">…your existing legend…</div>
      </div>
    </div>
  </div>

  <style>
    .dew-point-table {
      max-width: 700px;
      /* Reduce width for a narrower look */
      margin: 5px auto 0 !important;
      padding-top: 0 !important;
    }

    .dew-point-table table {
      font-size: 0.75rem;
      width: 100%;
      border-collapse: collapse;
    }

    .dew-point-table th,
    .dew-point-table td {
      padding: 2px 5px;
      /* Reduce padding */
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      .dew-point-table {
        max-width: 90%;
        /* Adjust for smaller screens */
      }

      .dew-point-table th,
      .dew-point-table td {
        padding: 2px 3px;
        /* More compact */
      }
    }
  </style>


  <!-- Dew Point Explanation Table -->
  <div class="mb-5 dew-point-table">
    <h2 style="font-size: 1rem; margin-bottom: 0.5rem;">
      How the dew point feels when exercising outdoors:
    </h2>
    <table class="table table-bordered">
      <thead>
        <tr>
          <th style="width: 30%; font-size: 0.75rem;">Dew Point Range</th>
          <th style="width: 70%; font-size: 0.75rem;">How It Feels</th>
        </tr>
      </thead>
      <tbody>
        <tr style="background-color: white; color: black;">
          <td>80+</td>
          <td>Stay indoors with the AC on!!</td>
        </tr>
        <tr style="background-color: darkred; color: white;">
          <td>75–80</td>
          <td>Extremely uncomfortable</td>
        </tr>
        <tr style="background-color: red; color: black;">
          <td>70–74</td>
          <td>Very uncomfortable</td>
        </tr>
        <tr style="background-color: orange; color: black;">
          <td>65–69</td>
          <td>Moderately uncomfortable</td>
        </tr>
        <tr style="background-color: yellow; color: black;">
          <td>60–64</td>
          <td>Slightly uncomfortable</td>
        </tr>
        <tr style="background-color: green; color: white;">
          <td>55–59</td>
          <td>Comfortable</td>
        </tr>
        <tr style="background-color: blue; color: white;">
          <td>50–54</td>
          <td>Very comfortable</td>
        </tr>
        <tr style="background-color: white; color: black;">
          <td>0–50</td>
          <td>Won't break a sweat!!</td>
        </tr>
      </tbody>
    </table>
  </div>

<!-- External Links Section -->
<div class="mb-5">
  <div>
    <div class="text-center">
      <a class="d-flex flex-column align-items-center justify-content-center" href="https://www.alextran.org/dew-point/"
        target="_blank" style="max-width: 300px; margin: 0 auto;">
        <img src="/static/wordpress.png" alt="link" style="margin-bottom: 10px; height: 50px; border-radius: 50%;">
        <span style="font-size: 0.9rem; word-wrap: break-word;">
          Link to an interesting explanation of why dew point is a great indicator of how working outdoors will feel
        </span>
      </a>
    </div>
  </div>
</div>
</div>

<!-- Chart.js Scripts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
  // --- Canvas ---
  const canvas = document.getElementById('dewPointChart');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');

  // --- Colors: use dark page text for items drawn ON the white canvas ---
  const cs   = getComputedStyle(document.documentElement);
  const ink  = (cs.getPropertyValue('--text') || '#25344a').trim();          // text on white
  const grid = '#e7eaf0';                                                    // light grey grid

  // --- Translucent background bands (so lines stay readable) ---
  const colorBandsPlugin = {
    id: 'colorBandsPlugin',
    beforeDatasetsDraw(chart) {
      const y = chart.scales?.y, a = chart.chartArea;
      if (!y || !a) return;
      const c = chart.ctx;
      const bands = [
        { color:'rgba(0,0,255,.14)',    from:50, to:55 },
        { color:'rgba(0,128,0,.14)',    from:55, to:60 },
        { color:'rgba(255,215,0,.14)',  from:60, to:65 },
        { color:'rgba(255,165,0,.14)',  from:65, to:70 },
        { color:'rgba(255,0,0,.14)',    from:70, to:75 },
        { color:'rgba(139,0,0,.14)',    from:75, to:80 },
        { color:'rgba(255,255,255,1)',  from:80, to:100 }
      ];
      c.save();
      bands.forEach(b=>{
        const top = y.getPixelForValue(b.to);
        const bot = y.getPixelForValue(b.from);
        c.fillStyle = b.color;
        c.fillRect(a.left, top, a.right - a.left, bot - top);
      });
      c.restore();
    }
  };

  // --- Data from Flask (always valid JS) ---
  const forecasts = {{ forecasts | default([], true) | tojson }};
  console.log('forecast sample:', forecasts?.[0]);

  // Convert to {x,y} points (robust to parsing)
  const toDate = s => new Date(typeof s === 'string' ? s.replace(' ', 'T') : s);
  const num    = v => (v===''||v==null) ? NaN : Number(v);

  const dp = (forecasts||[]).map(f => ({ x: toDate(f.time), y: num(f.dew_point ?? f.dew_point_f ?? f.dp) }))
                            .filter(p => isFinite(p.y) && !isNaN(p.x));
  const tp = (forecasts||[]).map(f => ({ x: toDate(f.time), y: num(f.temp ?? f.temperature) }))
                            .filter(p => isFinite(p.y) && !isNaN(p.x));
  const rh = (forecasts||[]).map(f => ({ x: toDate(f.time), y: num(f.humidity ?? f.rh) }))
                            .filter(p => isFinite(p.y) && !isNaN(p.x));

  console.log('points count → dp/temp/rh:', dp.length, tp.length, rh.length);

  // --- Chart config ---
  const data = {
    datasets: [
      { label:'Dew Point (°F)',        data: dp,
        borderColor:'rgba(0,0,0,.8)', pointBackgroundColor:'black', pointBorderColor:'black',
        fill:false, tension:.3, pointRadius:2, pointHoverRadius:4, pointBorderWidth:1, pointHitRadius:5 },
      { label:'Temperature (°F)',      data: tp,
        borderColor:'aqua', fill:false, tension:.3, pointRadius:2, pointHoverRadius:4, pointBorderWidth:1, pointHitRadius:5 },
      { label:'Relative Humidity (%)', data: rh,
        borderColor:'rgba(30,144,255,1)', fill:false, tension:.3, pointRadius:2, pointHoverRadius:4, pointBorderWidth:1, pointHitRadius:5 }
    ]
  };

  const options = {
    responsive:true,
    maintainAspectRatio:false,
    parsing:false, // using {x,y}
    scales:{
      x:{
        type:'time',
        time:{ unit:'hour', displayFormats:{ hour:'MMM d HH:mm' } },
        ticks:{ color: ink }, grid:{ color: grid },
        title:{ display:true, text:'Time of Day', font:{ size:20 }, color: ink }
      },
      y:{
        beginAtZero:false, min:50, max:100,
        ticks:{ stepSize:5, color: ink }, grid:{ color: grid },
        title:{ display:true, text:'Values', font:{ size:20 }, color: ink }
      }
    },
    plugins:{
      legend:{ labels:{ color: ink, font:{ size:18 } } }, // legend on white canvas
      tooltip:{ bodyFont:{ size:18 }, titleFont:{ size:18 } }
    }
  };

  // Destroy any prior chart bound to this canvas (safe)
  const existing = Chart.getChart(canvas);
  if (existing) existing.destroy();

  new Chart(ctx, { type:'line', data, options, plugins:[colorBandsPlugin] });
});
</script>


{% endblock %}